# å¢¨æ°´å± AI é˜…è¯»å™¨ - ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬ï¼š** 1.0.0  
**æ—¥æœŸï¼š** 2024 å¹´ 12 æœˆ  
**ä½œè€…ï¼š** Winston (AI æ¶æ„å¸ˆ)  
**é¡¹ç›®ï¼š** å¢¨æ°´å± AI é˜…è¯»å™¨

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„å†³ç­–](#æ¶æ„å†³ç­–)
3. [æŠ€æœ¯æ ˆé€‰æ‹©](#æŠ€æœ¯æ ˆé€‰æ‹©)
4. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
5. [ç»„ä»¶è®¾è®¡](#ç»„ä»¶è®¾è®¡)
6. [å¤–éƒ¨ API é›†æˆ](#å¤–éƒ¨apié›†æˆ)
7. [æ ¸å¿ƒå·¥ä½œæµç¨‹](#æ ¸å¿ƒå·¥ä½œæµç¨‹)
8. [æ•°æ®åº“æ¶æ„](#æ•°æ®åº“æ¶æ„)
9. [æºç ç›®å½•ç»“æ„](#æºç ç›®å½•ç»“æ„)
10. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
11. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
12. [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
13. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
14. [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
15. [é¡¹ç›®æ€»ç»“](#é¡¹ç›®æ€»ç»“)

---

## é¡¹ç›®æ¦‚è¿°

### èƒŒæ™¯å’Œç›®æ ‡

å¢¨æ°´å± AI é˜…è¯»å™¨æ˜¯ä¸“ä¸º Android å¢¨æ°´å±è®¾å¤‡ï¼ˆå¦‚æ–‡çŸ³ P6ï¼‰è®¾è®¡çš„æ™ºèƒ½ EPUB é˜…è¯»åº”ç”¨ã€‚é¡¹ç›®æ—¨åœ¨ç»“åˆå…ˆè¿›çš„ AI æŠ€æœ¯ä¸ä¸“ä¸šçš„å¢¨æ°´å±ä¼˜åŒ–ï¼Œä¸ºç”¨æˆ·æä¾›æ²‰æµ¸å¼çš„æ™ºèƒ½é˜…è¯»ä½“éªŒã€‚

### æ ¸å¿ƒåŠŸèƒ½

- **ğŸ“š EPUB é˜…è¯»å™¨** - æ”¯æŒ EPUB 2.0/3.0 æ ¼å¼ï¼Œä¼˜åŒ–çš„æ¸²æŸ“æ€§èƒ½
- **ğŸ¤– AI æ™ºèƒ½é—®ç­”** - åŸºäº OpenAI API çš„æ–‡æœ¬ç†è§£å’Œæ¦‚å¿µè§£é‡Š
- **ğŸ¤ è¯­éŸ³äº¤äº’** - è¯­éŸ³è¾“å…¥è¯†åˆ«å’Œ AI è¯­éŸ³å›ç­”
- **ğŸ–¥ï¸ å¢¨æ°´å±ä¼˜åŒ–** - æ™ºèƒ½åˆ·æ–°ç­–ç•¥å’Œè§¦æ§å“åº”ä¼˜åŒ–
- **ğŸ“Š é˜…è¯»ç®¡ç†** - è¿›åº¦è·Ÿè¸ªã€ä¹¦ç­¾ç®¡ç†ã€ä¸ªæ€§åŒ–è®¾ç½®

### ç›®æ ‡ç”¨æˆ·

- **å­¦ç”Ÿå’Œç ”ç©¶äººå‘˜** - éœ€è¦æ·±å…¥ç†è§£å­¦æœ¯æ–‡æœ¬å’Œä¸“ä¸šæœ¯è¯­
- **è¯­è¨€å­¦ä¹ è€…** - éœ€è¦å®æ—¶ç¿»è¯‘å’Œè¯æ±‡è§£é‡ŠåŠŸèƒ½
- **ä¸“ä¸šé˜…è¯»è€…** - é‡è§†é˜…è¯»ä½“éªŒå’ŒçŸ¥è¯†ç®¡ç†çš„ç”¨æˆ·
- **å¢¨æ°´å±è®¾å¤‡ç”¨æˆ·** - ä½¿ç”¨æ–‡çŸ³ã€Kindle ç­‰ E-ink è®¾å¤‡çš„ç”¨æˆ·

---

## æ¶æ„å†³ç­–

### æ€»ä½“æ¶æ„æ–¹æ¡ˆ

**æ¶æ„é£æ ¼ï¼š** Clean Architecture + MVVM  
**æœåŠ¡æ¶æ„ï¼š** å•ä½“åº”ç”¨ï¼ˆMonolithï¼‰  
**æ•°æ®ç­–ç•¥ï¼š** æœ¬åœ°ä¼˜å…ˆï¼ˆLocal-Firstï¼‰  
**å¹³å°é€‰æ‹©ï¼š** Android åŸç”Ÿå¼€å‘

### å…³é”®è®¾è®¡åŸåˆ™

1. **å¢¨æ°´å±ä¼˜å…ˆ** - æ‰€æœ‰ UI å’Œäº¤äº’é’ˆå¯¹ E-ink æ˜¾ç¤ºç‰¹æ€§ä¼˜åŒ–
2. **éšç§ä¿æŠ¤** - ç”¨æˆ·æ•°æ®å®Œå…¨æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¸Šä¼ ä»»ä½•ä¸ªäººä¿¡æ¯
3. **ç¦»çº¿ä¼˜å…ˆ** - æ ¸å¿ƒåŠŸèƒ½æ— éœ€ç½‘ç»œè¿æ¥å³å¯ä½¿ç”¨
4. **æ€§èƒ½è‡³ä¸Š** - é’ˆå¯¹èµ„æºå—é™è®¾å¤‡çš„æ·±åº¦ä¼˜åŒ–
5. **æ¨¡å—åŒ–è®¾è®¡** - é«˜å†…èšä½è€¦åˆçš„ç»„ä»¶æ¶æ„

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Presentation Layer                â”‚
â”‚        (Activities, Fragments, ViewModels)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Domain Layer                   â”‚
â”‚           (Use Cases, Entities, Repositories)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Data Layer                    â”‚
â”‚    (Local DB, Remote API, File Management)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Core Modules                   â”‚
â”‚  (EPUB Parser, AI Service, Eink Optimization)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯æ ˆé€‰æ‹©

### æ ¸å¿ƒæŠ€æœ¯å†³ç­–

| æŠ€æœ¯é¢†åŸŸ      | é€‰æ‹©æ–¹æ¡ˆ                      | å†³ç­–ç†ç”±                                   |
| ------------- | ----------------------------- | ------------------------------------------ |
| **å¼€å‘è¯­è¨€**  | Kotlin                        | Android å®˜æ–¹æ¨èï¼Œç©ºå®‰å…¨ï¼Œåç¨‹æ”¯æŒå¼‚æ­¥å¤„ç† |
| **æ¶æ„æ¨¡å¼**  | MVVM + Clean Architecture     | æ¸…æ™°åˆ†å±‚ï¼Œæ˜“æµ‹è¯•ï¼Œå¯ç»´æŠ¤æ€§é«˜               |
| **UI æ¡†æ¶**   | Android åŸç”Ÿ + è‡ªå®šä¹‰ WebView | ç²¾ç¡®æ§åˆ¶å¢¨æ°´å±æ˜¾ç¤ºæ•ˆæœ                     |
| **æ•°æ®åº“**    | Room + SQLite                 | æˆç†Ÿç¨³å®šï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢å’Œäº‹åŠ¡               |
| **ç½‘ç»œè¯·æ±‚**  | Retrofit + OkHttp             | æ ‡å‡† HTTP å®¢æˆ·ç«¯ï¼Œæ”¯æŒæ‹¦æˆªå™¨å’Œç¼“å­˜         |
| **å¼‚æ­¥å¤„ç†**  | Kotlin Coroutines             | ç°ä»£å¼‚æ­¥ç¼–ç¨‹ï¼Œé¿å…å›è°ƒåœ°ç‹±                 |
| **ä¾èµ–æ³¨å…¥**  | Hilt                          | Google æ¨èï¼ŒåŸºäº Dagger2ï¼Œç®€åŒ–é…ç½®        |
| **EPUB è§£æ** | epublib-android               | æˆç†Ÿçš„ EPUB è§£æåº“ï¼Œæ”¯æŒ 2.0/3.0 æ ‡å‡†      |
| **AI é›†æˆ**   | OpenAI API                    | ä¸šç•Œé¢†å…ˆçš„å¤§è¯­è¨€æ¨¡å‹æœåŠ¡                   |

### å¼€å‘å·¥å…·é“¾

- **IDEï¼š** Android Studio
- **æ„å»ºç³»ç»Ÿï¼š** Gradle (Kotlin DSL)
- **ç‰ˆæœ¬æ§åˆ¶ï¼š** Git
- **æµ‹è¯•æ¡†æ¶ï¼š** JUnit 5 + Espresso + Mockito
- **é™æ€åˆ†æï¼š** Android Lint + Detekt
- **æ€§èƒ½åˆ†æï¼š** Android Profiler + LeakCanary

---

## æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“å…³ç³»

```mermaid
erDiagram
    Book ||--o{ Chapter : contains
    Book ||--|| ReadingProgress : tracks
    Book ||--o{ Bookmark : has
    Book ||--o{ AIConversation : generates
    Book ||--o{ TextSelection : selects

    AIConversation ||--o{ AIResponse : receives

    Book {
        string bookId PK
        string filePath
        string title
        string author
        string publisher
        string language
        string coverImagePath
        long fileSize
        int totalChapters
        long createdAt
        long lastOpenedAt
        boolean isDeleted
    }

    Chapter {
        string chapterId PK
        string bookId FK
        int chapterIndex
        string title
        string resourcePath
        string anchor
        int wordCount
        int estimatedReadingTime
    }

    ReadingProgress {
        string progressId PK
        string bookId FK
        int chapterIndex
        int paragraphIndex
        int characterOffset
        float progressPercent
        long lastUpdated
    }

    Bookmark {
        string bookmarkId PK
        string bookId FK
        int chapterIndex
        int paragraphIndex
        string selectedText
        string note
        long createdAt
    }

    AIConversation {
        string conversationId PK
        string bookId FK
        string selectedText
        string context
        string questionType
        long createdAt
    }

    AIResponse {
        string responseId PK
        string conversationId FK
        string content
        string contentHash
        int tokenCount
        long responseTime
        long createdAt
    }
```

### æ•°æ®è®¾è®¡å…³é”®å†³ç­–

1. **å­—ç¬¦ä¸² ID ç­–ç•¥** - ä½¿ç”¨ UUID ç¡®ä¿å…¨å±€å”¯ä¸€æ€§ï¼Œæ”¯æŒæ•°æ®è¿ç§»
2. **è½¯åˆ é™¤è®¾è®¡** - å…³é”®å®ä½“ä½¿ç”¨`isDeleted`æ ‡è®°ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®
3. **æ—¶é—´æˆ³ç»Ÿä¸€** - ä½¿ç”¨ Long ç±»å‹å­˜å‚¨æ¯«ç§’æ—¶é—´æˆ³ï¼Œé¿å…æ—¶åŒºé—®é¢˜
4. **å†…å®¹å“ˆå¸Œç¼“å­˜** - AI å›ç­”ä½¿ç”¨å†…å®¹å“ˆå¸Œå®ç°æ™ºèƒ½ç¼“å­˜

---

## ç»„ä»¶è®¾è®¡

### ç³»ç»Ÿç»„ä»¶æ¶æ„

```mermaid
graph TB
    subgraph "UI Layer"
        A[ReadingFragment]
        B[BookListFragment]
        C[AIDialogFragment]
    end

    subgraph "EPUB Engine"
        D[EpubParserService]
        E[ChapterNavigationService]
    end

    subgraph "AI Services"
        F[OpenAIApiService]
        G[AIResponseCacheService]
        H[VoiceInputManager]
    end

    subgraph "Reading Experience"
        I[PageRenderingEngine]
        J[TextSelectionManager]
    end

    subgraph "E-ink Optimization"
        K[EinkRefreshManager]
        L[TouchGestureHandler]
    end

    subgraph "Data Layer"
        M[BookRepository]
        N[AIRepository]
        O[Room Database]
    end

    A --> I
    A --> J
    A --> K
    A --> L
    B --> D
    B --> E
    C --> F
    C --> G
    C --> H

    E --> M
    I --> E
    J --> I

    F --> N
    G --> N
    H --> F

    D --> M
    M --> O
    N --> O
```

### å…³é”®ç»„ä»¶è¯¦è§£

#### 1. EpubParserServiceï¼ˆEPUB è§£ææœåŠ¡ï¼‰

**èŒè´£ï¼š** è§£æ EPUB æ–‡ä»¶ï¼Œæå–å…ƒæ•°æ®å’Œç« èŠ‚å†…å®¹

**æ ¸å¿ƒæ¥å£ï¼š**

```kotlin
interface EpubParserService {
    suspend fun parseEpub(filePath: String): Result<BookMetadata>
    suspend fun extractChapters(filePath: String): List<Chapter>
    suspend fun getChapterContent(filePath: String, chapterPath: String): String
    suspend fun extractCoverImage(filePath: String): String?
    suspend fun validateEpubFile(filePath: String): ValidationResult
}
```

#### 2. OpenAIApiServiceï¼ˆAI æœåŠ¡ï¼‰

**èŒè´£ï¼š** å¤„ç† OpenAI API è°ƒç”¨å’Œ AI åŠŸèƒ½é›†æˆ

**æ ¸å¿ƒæ¥å£ï¼š**

```kotlin
interface OpenAIApiService {
    suspend fun processTextQuestion(
        selectedText: String,
        questionType: QuestionType,
        context: String
    ): Result<AIResponse>

    suspend fun processVoiceInput(
        audioData: ByteArray,
        selectedText: String
    ): Result<AIResponse>

    suspend fun transcribeAudio(audioData: ByteArray): Result<String>
}
```

#### 3. EinkRefreshManagerï¼ˆå¢¨æ°´å±ä¼˜åŒ–ï¼‰

**èŒè´£ï¼š** ç®¡ç†å¢¨æ°´å±åˆ·æ–°ç­–ç•¥å’Œæ˜¾ç¤ºä¼˜åŒ–

**æ ¸å¿ƒæ¥å£ï¼š**

```kotlin
interface EinkRefreshManager {
    fun optimizeRefreshForOperation(operation: RefreshOperation): RefreshMode
    fun configureRefreshStrategy(strategy: RefreshStrategy)
    fun handleGhostingDetection(): Boolean
    fun applyDeviceSpecificOptimizations(deviceProfile: EinkDeviceProfile)
}
```

---

## å¤–éƒ¨ API é›†æˆ

### OpenAI API é›†æˆæ–¹æ¡ˆ

#### API ç«¯ç‚¹ä½¿ç”¨

1. **Chat Completions API** - æ–‡æœ¬æ™ºèƒ½é—®ç­”

   - ç«¯ç‚¹ï¼š`POST /v1/chat/completions`
   - æ¨¡å‹ï¼šGPT-4
   - ç”¨é€”ï¼šæ¦‚å¿µè§£é‡Šã€ç¿»è¯‘ã€æ€»ç»“ã€æ‰©å±•é˜…è¯»

2. **Whisper API** - è¯­éŸ³è½¬æ–‡æœ¬
   - ç«¯ç‚¹ï¼š`POST /v1/audio/transcriptions`
   - æ¨¡å‹ï¼šwhisper-1
   - ç”¨é€”ï¼šè¯­éŸ³è¾“å…¥å¤„ç†

#### å®‰å…¨æªæ–½

- **API å¯†é’¥ä¿æŠ¤** - åˆ†ç‰‡å­˜å‚¨ + Android Keystore åŠ å¯†
- **è¯·æ±‚ç­¾å** - æ•°å­—ç­¾åéªŒè¯å…³é”®è¯·æ±‚
- **é€Ÿç‡é™åˆ¶** - æœ¬åœ°é™æµé¿å… API æ»¥ç”¨
- **é”™è¯¯å¤„ç†** - æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

#### ç¤ºä¾‹é…ç½®

```kotlin
class OpenAIConfig {
    companion object {
        const val BASE_URL = "https://api.openai.com/v1/"
        const val DEFAULT_MODEL = "gpt-4"
        const val MAX_TOKENS = 500
        const val TEMPERATURE = 0.3
        const val REQUEST_TIMEOUT = 30_000L // 30ç§’
        const val MAX_RETRY_ATTEMPTS = 3
    }
}
```

---

## æ ¸å¿ƒå·¥ä½œæµç¨‹

### 1. å›¾ä¹¦æ‰“å¼€æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant BF as BookListFragment
    participant BVM as BookListViewModel
    participant EPS as EpubParserService
    participant RF as ReadingFragment
    participant RVM as ReadingViewModel
    participant PRE as PageRenderingEngine

    U->>BF: ç‚¹å‡»é€‰æ‹©å›¾ä¹¦
    BF->>BVM: selectBook(bookId)
    BVM->>EPS: parseEpub(filePath)
    EPS-->>BVM: è¿”å›å›¾ä¹¦å…ƒæ•°æ®
    BVM->>RF: å¯¼èˆªåˆ°é˜…è¯»ç•Œé¢
    RF->>RVM: initializeBook(bookId)
    RVM->>PRE: renderFirstPage()
    PRE-->>RF: æ˜¾ç¤ºé¡µé¢å†…å®¹
    RF-->>U: å®Œæˆå›¾ä¹¦æ‰“å¼€
```

### 2. AI é—®ç­”äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant RF as ReadingFragment
    participant TSM as TextSelectionManager
    participant AIVM as AIViewModel
    participant OAAS as OpenAIApiService
    participant ADF as AIDialogFragment

    U->>RF: é•¿æŒ‰é€‰æ‹©æ–‡æœ¬
    RF->>TSM: startSelection()
    TSM-->>RF: æ˜¾ç¤ºé€‰æ‹©å·¥å…·æ 
    U->>RF: ç‚¹å‡»AIé—®ç­”æŒ‰é’®
    RF->>AIVM: processTextSelection()
    AIVM->>OAAS: sendAPIRequest()
    OAAS-->>AIVM: è¿”å›AIå›ç­”
    AIVM->>ADF: æ˜¾ç¤ºAIå¯¹è¯ç•Œé¢
    ADF-->>U: å±•ç¤ºAIå›ç­”
```

---

## æ•°æ®åº“æ¶æ„

### Room æ•°æ®åº“è®¾è®¡

```kotlin
@Database(
    entities = [
        BookEntity::class,
        ChapterEntity::class,
        ReadingProgressEntity::class,
        BookmarkEntity::class,
        AIConversationEntity::class,
        AIResponseEntity::class,
        UserPreferencesEntity::class,
        TextSelectionEntity::class
    ],
    version = 1,
    exportSchema = false
)
@TypeConverters(DatabaseConverters::class)
abstract class InkReaderDatabase : RoomDatabase() {
    abstract fun bookDao(): BookDao
    abstract fun chapterDao(): ChapterDao
    abstract fun readingProgressDao(): ReadingProgressDao
    abstract fun bookmarkDao(): BookmarkDao
    abstract fun aiConversationDao(): AIConversationDao
    abstract fun aiResponseDao(): AIResponseDao
    abstract fun userPreferencesDao(): UserPreferencesDao
    abstract fun textSelectionDao(): TextSelectionDao
}
```

### å…³é”®ç´¢å¼•è®¾è®¡

```kotlin
@Entity(
    tableName = "books",
    indices = [
        Index(value = ["bookId"]),
        Index(value = ["createdAt"]),
        Index(value = ["lastOpenedAt"]),
        Index(value = ["isDeleted"]),
        Index(value = ["author", "title"])
    ]
)
data class BookEntity(...)
```

### æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

- **æŸ¥è¯¢ä¼˜åŒ–** - å¤åˆç´¢å¼•æ”¯æŒå¸¸ç”¨æŸ¥è¯¢æ¨¡å¼
- **åˆ†é¡µåŠ è½½** - å¤§æ•°æ®é›†ä½¿ç”¨ Paging 3 ç»„ä»¶
- **äº‹åŠ¡ç®¡ç†** - æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **ç¼“å­˜ç­–ç•¥** - Room å†…ç½®æŸ¥è¯¢ç¼“å­˜ + åº”ç”¨å±‚ LRU ç¼“å­˜

---

## æºç ç›®å½•ç»“æ„

```
ink-agent/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ src/main/java/com/newbiechen/inkreader/
â”‚   â”‚   â”œâ”€â”€ application/                   # åº”ç”¨å…¥å£å’Œå…¨å±€é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ InkReaderApplication.kt
â”‚   â”‚   â”‚   â””â”€â”€ di/                        # ä¾èµ–æ³¨å…¥æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ presentation/                  # è¡¨ç°å±‚ï¼ˆMVVMï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ activities/
â”‚   â”‚   â”‚   â”œâ”€â”€ fragments/
â”‚   â”‚   â”‚   â”œâ”€â”€ viewmodels/
â”‚   â”‚   â”‚   â””â”€â”€ adapters/
â”‚   â”‚   â”œâ”€â”€ domain/                        # é¢†åŸŸå±‚ï¼ˆClean Architectureï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ usecases/
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ data/                          # æ•°æ®å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ local/                     # æœ¬åœ°æ•°æ®æº
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ preferences/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ file/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/                    # è¿œç¨‹æ•°æ®æº
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ openai/
â”‚   â”‚   â”‚   â””â”€â”€ repositories/              # ä»“å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ core/                          # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ epub/                      # EPUBå¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/                        # AIæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ reading/                   # é˜…è¯»ä½“éªŒ
â”‚   â”‚   â”‚   â””â”€â”€ eink/                      # å¢¨æ°´å±ä¼˜åŒ–
â”‚   â”‚   â””â”€â”€ utils/                         # å·¥å…·ç±»
â”‚   â”œâ”€â”€ src/test/                          # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ src/androidTest/                   # UIæµ‹è¯•
â”œâ”€â”€ docs/                                  # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ prd.md
â”‚   â””â”€â”€ architecture.md
â””â”€â”€ README.md
```

### æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

1. **æŒ‰åŠŸèƒ½åˆ†å±‚** - presentation/domain/data æ¸…æ™°åˆ†ç¦»
2. **æŒ‰ä¸šåŠ¡åˆ†ç»„** - core æ¨¡å—æŒ‰åŠŸèƒ½åŸŸç»„ç»‡
3. **ä¾èµ–æ–¹å‘** - é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—å®ç°
4. **æµ‹è¯•å‹å¥½** - æ¯ä¸ªæ¨¡å—éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç»“æ„

---

## å®‰å…¨è€ƒè™‘

### æ•°æ®ä¿æŠ¤ç­–ç•¥

#### 1. æœ¬åœ°æ•°æ®åŠ å¯†

```kotlin
// æ•°æ®åº“åŠ å¯†é…ç½®
@Database(/* ... */)
@TypeConverters(EncryptionConverter::class)
abstract class InkReaderDatabase : RoomDatabase() {

    companion object {
        fun build(context: Context): InkReaderDatabase {
            val passphrase = KeystoreManager.getOrCreateDatabaseKey()
            return Room.databaseBuilder(context, InkReaderDatabase::class.java, "ink_reader.db")
                .openHelperFactory(SupportFactory(passphrase))
                .build()
        }
    }
}
```

#### 2. API å¯†é’¥ä¿æŠ¤

```kotlin
class OpenAISecurityManager {
    private val keystoreManager = KeystoreManager()

    // APIå¯†é’¥åˆ†ç‰‡ä¿æŠ¤
    private val keyFragments = arrayOf(
        "sk-proj-",
        getEncryptedFragment1(),
        getEncryptedFragment2()
    )

    fun getSecureApiKey(): String {
        val reconstructedKey = keyFragments.joinToString("")
        return keystoreManager.decrypt(reconstructedKey)
    }
}
```

#### 3. ç½‘ç»œå®‰å…¨

```kotlin
class SecureNetworkModule {
    @Provides
    fun provideSecureOkHttpClient(): OkHttpClient {
        return OkHttpClient.Builder()
            .certificatePinner(
                CertificatePinner.Builder()
                    .add("api.openai.com", "sha256/CERTIFICATE_PIN")
                    .build()
            )
            .addInterceptor(SecurityHeadersInterceptor())
            .protocols(listOf(Protocol.HTTP_2))
            .connectionSpecs(listOf(ConnectionSpec.RESTRICTED_TLS))
            .build()
    }
}
```

### éšç§ä¿æŠ¤æªæ–½

1. **æ•°æ®æœ€å°åŒ–** - ä»…æ”¶é›†åŠŸèƒ½å¿…éœ€çš„æœ€å°æ•°æ®é›†
2. **ç”¨æˆ·æ§åˆ¶** - å®Œæ•´çš„æ•°æ®å¯¼å‡ºã€åˆ é™¤åŠŸèƒ½
3. **é€æ˜åº¦** - æ¸…æ™°çš„éšç§æ”¿ç­–å’Œæ•°æ®ä½¿ç”¨è¯´æ˜
4. **æœ¬åœ°å¤„ç†** - æ‰€æœ‰æ•æ„Ÿæ•°æ®åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼ 

---

## æ€§èƒ½ä¼˜åŒ–

### å¢¨æ°´å±æ˜¾ç¤ºä¼˜åŒ–

#### æ™ºèƒ½åˆ·æ–°ç­–ç•¥

```kotlin
class EinkRefreshManager {
    private var fastRefreshCount = 0
    private val maxFastRefreshBeforeGC = 10

    fun optimizeRefreshForOperation(operation: RefreshOperation): RefreshMode {
        return when (operation) {
            RefreshOperation.PAGE_TURN -> {
                fastRefreshCount++
                if (fastRefreshCount >= maxFastRefreshBeforeGC) {
                    fastRefreshCount = 0
                    RefreshMode.FULL_REFRESH
                } else {
                    RefreshMode.FAST_REFRESH
                }
            }
            RefreshOperation.UI_NAVIGATION -> {
                fastRefreshCount = 0
                RefreshMode.FULL_REFRESH
            }
            RefreshOperation.TEXT_SELECTION -> RefreshMode.PARTIAL_REFRESH
        }
    }
}
```

### å†…å­˜ç®¡ç†ä¼˜åŒ–

#### å¤šçº§ç¼“å­˜ç­–ç•¥

```kotlin
class MemoryOptimizedCacheManager {
    // L1ç¼“å­˜ï¼šå½“å‰ç« èŠ‚ï¼ˆå†…å­˜ï¼‰
    private val currentChapterCache = LruCache<String, ChapterContent>(1)

    // L2ç¼“å­˜ï¼šç›¸é‚»ç« èŠ‚ï¼ˆå†…å­˜ï¼‰
    private val adjacentChapterCache = LruCache<String, ChapterContent>(2)

    // L3ç¼“å­˜ï¼šå›¾ä¹¦å…ƒæ•°æ®ï¼ˆæŒä¹…åŒ–ï¼‰
    private val bookMetadataCache = LruCache<String, BookMetadata>(50)

    // å›¾ç‰‡ç¼“å­˜ï¼ˆç£ç›˜+å†…å­˜ï¼‰
    private val imageCache = DualLevelImageCache(
        memorySize = 20 * 1024 * 1024,  // 20MB
        diskSize = 100 * 1024 * 1024     // 100MB
    )
}
```

### æ€§èƒ½ç›®æ ‡

| æ€§èƒ½æŒ‡æ ‡         | ç›®æ ‡å€¼    | ä¼˜åŒ–æªæ–½               |
| ---------------- | --------- | ---------------------- |
| **åº”ç”¨å¯åŠ¨æ—¶é—´** | < 2 ç§’    | å»¶è¿Ÿåˆå§‹åŒ–ã€é¢„åŠ è½½ä¼˜åŒ– |
| **å›¾ä¹¦æ‰“å¼€æ—¶é—´** | < 1.5 ç§’  | æµå¼è§£æã€ç¼“å­˜æœºåˆ¶     |
| **ç¿»é¡µå“åº”å»¶è¿Ÿ** | < 300ms   | æ™ºèƒ½é¢„è½½ã€åˆ·æ–°ä¼˜åŒ–     |
| **å†…å­˜å ç”¨**     | < 200MB   | å¤šçº§ç¼“å­˜ã€åŠæ—¶å›æ”¶     |
| **ç”µæ± ç»­èˆª**     | > 20 å°æ—¶ | åå°ä¼˜åŒ–ã€CPU èŠ‚èƒ½     |

---

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç³»ç»Ÿè®¾è®¡

```kotlin
object InkReaderLogger {
    private const val MAX_LOG_FILE_SIZE = 10 * 1024 * 1024  // 10MB
    private const val LOG_RETENTION_DAYS = 7

    fun error(tag: String, message: String, throwable: Throwable? = null) {
        val logEntry = createLogEntry(LogLevel.ERROR, tag, message, throwable)
        writeToLogFile(LogLevel.ERROR, logEntry)

        if (throwable != null) {
            ErrorTracker.trackError(throwable, tag, message)
        }
    }

    private fun createLogEntry(
        level: LogLevel,
        tag: String,
        message: String,
        throwable: Throwable? = null
    ): LogEntry {
        return LogEntry(
            timestamp = System.currentTimeMillis(),
            level = level,
            tag = tag,
            message = message,
            threadName = Thread.currentThread().name,
            stackTrace = throwable?.stackTraceToString(),
            sessionId = SessionManager.getCurrentSessionId()
        )
    }
}
```

### æ€§èƒ½ç›‘æ§

```kotlin
class PerformanceMonitor {
    fun trackOperation(operationName: String, block: suspend () -> Unit) {
        val startTime = System.currentTimeMillis()
        val startMemory = getUsedMemory()

        try {
            runBlocking { block() }
        } finally {
            val endTime = System.currentTimeMillis()
            val endMemory = getUsedMemory()

            val metric = PerformanceMetric(
                operationName = operationName,
                duration = endTime - startTime,
                memoryUsed = endMemory - startMemory,
                timestamp = startTime
            )

            checkPerformanceThresholds(metric)
        }
    }
}
```

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   UIæµ‹è¯• 10%    â”‚  â† ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œå…³é”®ç”¨æˆ·æµç¨‹
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  é›†æˆæµ‹è¯• 30%   â”‚  â† ç»„ä»¶äº¤äº’ï¼Œæ•°æ®åº“é›†æˆ
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  å•å…ƒæµ‹è¯• 60%   â”‚  â† ä¸šåŠ¡é€»è¾‘ï¼Œå·¥å…·ç±»æµ‹è¯•
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

#### å•å…ƒæµ‹è¯•

```kotlin
@RunWith(MockitoJUnitRunner::class)
class EpubParserServiceTest {
    @Mock private lateinit var fileManager: FileManager
    @InjectMocks private lateinit var epubParserService: EpubParserService

    @Test
    fun `parseEpubåº”è¯¥æˆåŠŸè§£ææœ‰æ•ˆçš„EPUBæ–‡ä»¶`() = runTest {
        // Given
        val validEpubPath = "test_resources/valid_book.epub"
        whenever(fileManager.exists(validEpubPath)).thenReturn(true)

        // When
        val result = epubParserService.parseEpub(validEpubPath)

        // Then
        assertThat(result.isSuccess).isTrue()
        assertThat(result.getOrNull()?.title).isNotEmpty()
    }
}
```

#### é›†æˆæµ‹è¯•

```kotlin
@RunWith(AndroidJUnit4::class)
class BookRepositoryImplTest {
    private lateinit var database: InkReaderDatabase
    private lateinit var repository: BookRepositoryImpl

    @Test
    fun æ·»åŠ æ–°å›¾ä¹¦åº”è¯¥è§¦å‘å®Œæ•´è§£ææµç¨‹() = runTest {
        // Given
        val filePath = "/storage/books/test_book.epub"

        // When
        val result = repository.addBook(filePath)

        // Then
        assertThat(result.isSuccess).isTrue()
        val savedBook = database.bookDao().getBookById(result.getOrNull()?.bookId)
        assertThat(savedBook).isNotNull()
    }
}
```

### è®¾å¤‡å…¼å®¹æ€§æµ‹è¯•

```kotlin
@RunWith(Parameterized::class)
class EinkDeviceCompatibilityTest(
    private val deviceProfile: EinkDeviceProfile
) {
    @Test
    fun å¢¨æ°´å±æ˜¾ç¤ºé€‚é…æµ‹è¯•() {
        configureDeviceEnvironment(deviceProfile)
        launchApp()

        // éªŒè¯ç•Œé¢é€‚é…
        onView(withId(R.id.reading_webview))
            .check(matches(isDisplayed()))
            .check(matches(hasTextSizeGreaterThan(MIN_READABLE_TEXT_SIZE)))

        // æµ‹è¯•åˆ·æ–°æ•ˆæœ
        testRefreshQuality()
    }
}
```

---

## éƒ¨ç½²ç­–ç•¥

### MVP æ„å»ºé…ç½®

```kotlin
// build.gradle.kts - ç®€åŒ–çš„æ„å»ºé…ç½®
android {
    defaultConfig {
        applicationId = "com.newbiechen.inkreader"
        minSdk = 28  // Android 9.0+
        targetSdk = 34
        versionCode = 1
        versionName = "1.0.0-mvp"
    }

    buildTypes {
        release {
            isMinifyEnabled = true
            isShrinkResources = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
}
```

### è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

```bash
#!/bin/bash
# build_mvp.sh - MVPç‰ˆæœ¬æ„å»ºè„šæœ¬

echo "ğŸš€ å¼€å§‹æ„å»ºå¢¨æ°´å±AIé˜…è¯»å™¨ MVPç‰ˆæœ¬..."

# æ¸…ç†å’Œæµ‹è¯•
./gradlew clean
./gradlew testMvpReleaseUnitTest

# æ„å»ºAPK
./gradlew assembleMvpRelease

echo "âœ… æ„å»ºå®Œæˆï¼"
echo "ğŸ“± APKè·¯å¾„: app/build/outputs/apk/mvp/release/app-mvp-release.apk"
echo "ğŸ“‹ å®‰è£…å‘½ä»¤: adb install -r app-mvp-release.apk"
```

### ç‰ˆæœ¬ç®¡ç†

```kotlin
object Version {
    const val MAJOR = 1
    const val MINOR = 0
    const val PATCH = 0
    const val BUILD = 1

    const val NAME = "$MAJOR.$MINOR.$PATCH-mvp"
    const val CODE = MAJOR * 10000 + MINOR * 100 + PATCH * 10 + BUILD

    const val CHANGELOG = """
        v1.0.0-mvp (Build 1)
        - âœ¨ EPUBå›¾ä¹¦ç®¡ç†å’Œé˜…è¯»åŠŸèƒ½
        - ğŸ¤– AIæ™ºèƒ½é—®ç­”ï¼ˆéœ€é…ç½®OpenAI API Keyï¼‰
        - ğŸ¤ è¯­éŸ³è¾“å…¥æ”¯æŒ
        - ğŸ–¥ï¸ å¢¨æ°´å±æ˜¾ç¤ºä¼˜åŒ–
        - ğŸ“± æ”¯æŒAndroid 9.0+è®¾å¤‡
        - ğŸ”’ å®Œå…¨æœ¬åœ°æ•°æ®å­˜å‚¨
    """
}
```

---

## é¡¹ç›®æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **ğŸ¯ æ˜ç¡®çš„æŠ€æœ¯å®šä½** - ä¸“ä¸ºå¢¨æ°´å±è®¾å¤‡å’Œ AI é˜…è¯»ä¼˜åŒ–
2. **ğŸ—ï¸ ç°ä»£åŒ–æ¶æ„è®¾è®¡** - Clean Architecture + MVVM ç¡®ä¿ä»£ç è´¨é‡
3. **ğŸ”’ éšç§ä¼˜å…ˆåŸåˆ™** - å®Œå…¨æœ¬åœ°å­˜å‚¨ï¼Œç”¨æˆ·æ•°æ®å®‰å…¨å¯æ§
4. **âš¡ æ€§èƒ½å·¥ç¨‹ä¼˜åŒ–** - é’ˆå¯¹èµ„æºå—é™è®¾å¤‡çš„ä¸“ä¸šè°ƒä¼˜

### å…³é”®æŠ€æœ¯å†³ç­–

- **Kotlin + Android åŸç”Ÿ** - ç¡®ä¿æ€§èƒ½å’Œè®¾å¤‡æ§åˆ¶èƒ½åŠ›
- **Room æ•°æ®åº“** - ç¨³å®šå¯é çš„æœ¬åœ°æ•°æ®å­˜å‚¨æ–¹æ¡ˆ
- **OpenAI API é›†æˆ** - ä¸šç•Œé¢†å…ˆçš„ AI èƒ½åŠ›æ”¯æŒ
- **æ¨¡å—åŒ–æ¶æ„** - é«˜å†…èšä½è€¦åˆï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

### æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡     | ç›®æ ‡å€¼    | æ¶æ„æ”¯æŒ      |
| -------- | --------- | ------------- |
| å¯åŠ¨æ—¶é—´ | < 2 ç§’    | âœ… å»¶è¿Ÿåˆå§‹åŒ– |
| ç¿»é¡µå»¶è¿Ÿ | < 300ms   | âœ… æ™ºèƒ½ç¼“å­˜   |
| å†…å­˜å ç”¨ | < 200MB   | âœ… å¤šçº§ç¼“å­˜   |
| ç”µæ± ç»­èˆª | > 20 å°æ—¶ | âœ… åŠŸè€—ä¼˜åŒ–   |

### å®æ–½å»ºè®®

**MVP å¼€å‘ä¼˜å…ˆçº§ï¼š**

1. **ç¬¬ä¸€é˜¶æ®µï¼ˆ2-3 å‘¨ï¼‰** - æ ¸å¿ƒé˜…è¯»åŠŸèƒ½
2. **ç¬¬äºŒé˜¶æ®µï¼ˆ2-3 å‘¨ï¼‰** - AI åŠŸèƒ½é›†æˆ
3. **ç¬¬ä¸‰é˜¶æ®µï¼ˆ1-2 å‘¨ï¼‰** - ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**æˆåŠŸå…³é”®å› ç´ ï¼š**

- æ—©æœŸè®¾å¤‡æµ‹è¯•å’Œç”¨æˆ·åé¦ˆ
- æŒç»­æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
- æ¸…æ™°çš„å¼€å‘ä¼˜å…ˆçº§ç®¡ç†
- ç¨³å®šçš„ OpenAI API é›†æˆ

### é£é™©è¯„ä¼°

| é£é™©é¡¹           | ç­‰çº§ | ç¼“è§£æªæ–½               |
| ---------------- | ---- | ---------------------- |
| å¢¨æ°´å±é€‚é…å¤æ‚æ€§ | ä¸­   | æ—©æœŸè®¾å¤‡æµ‹è¯•ï¼Œæ¸è¿›ä¼˜åŒ– |
| OpenAI API æˆæœ¬  | ä¸­   | æ™ºèƒ½ç¼“å­˜ï¼Œç”¨æˆ·è‡ªé…å¯†é’¥ |
| ç”¨æˆ·æ¥å—åº¦ä¸ç¡®å®š | ä¸­   | MVP å¿«é€ŸéªŒè¯ï¼Œåé¦ˆè¿­ä»£ |

---

**æ¶æ„è®¾è®¡å®Œæˆï¼Œç°åœ¨å¯ä»¥å¼€å§‹ç¼–ç å®ç°ï¼** ğŸš€

**ä¸‹ä¸€æ­¥ï¼š** åŸºäºæ­¤æ¶æ„æ–‡æ¡£è¿›è¡Œé¡¹ç›®åˆå§‹åŒ–å’Œæ ¸å¿ƒæ¨¡å—å¼€å‘ã€‚

---

_æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0.0_  
_æœ€åæ›´æ–°ï¼š2024 å¹´ 12 æœˆ_  
_æ¶æ„å¸ˆï¼šWinston_
